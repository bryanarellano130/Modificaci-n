{# templates/admin.html #}
{% extends "base.html" %}

{% block title %}Administración{% endblock %}

{% block content %}
<h1 class="mt-4">⚙️ Administración del Sistema</h1>
<p>Configura parámetros globales, gestiona usuarios y realiza tareas de mantenimiento.</p>
<hr>

{# Mostrar mensajes flash si los hay #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{# --- Sección de Configuración --- #}
<div class="card mb-4">
    <div class="card-header">Configuración General</div>
    <div class="card-body">
        {# Usamos un formulario que apunta a la ruta de acciones #}
        <form method="POST" action="{{ url_for('admin_actions') }}">
            {# Campo oculto para indicar la acción específica #}
            <input type="hidden" name="action" value="update_threshold">

            <div class="mb-3">
                <label for="glm_threshold_admin" class="form-label">Umbral de Decisión Modelo GLM:
                    <span id="thresholdValueAdmin" class="badge bg-secondary">{{ '%.2f'|format(glm_threshold) }}</span>
                </label>
                <input type="range" class="form-range" id="glm_threshold_admin" name="glm_threshold_admin"
                       min="0.1" max="0.9" step="0.05" value="{{ glm_threshold }}"
                       oninput="document.getElementById('thresholdValueAdmin').textContent = parseFloat(this.value).toFixed(2);">
                 <small class="form-text text-muted">Ajusta la sensibilidad del modelo de detección.</small>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Actualizar Umbral</button>
        </form>

        <hr>

        <form method="POST" action="{{ url_for('admin_actions') }}">
            <input type="hidden" name="action" value="update_alert_config">
             <div class="mb-3">
                <label for="alert_severity_threshold_admin" class="form-label">Umbral Mínimo de Severidad para Alertas:</label>
                <select class="form-select form-select-sm" id="alert_severity_threshold_admin" name="alert_severity_threshold_admin">
                    {% for level in alert_severity_levels %}
                        <option value="{{ level }}" {% if level == alert_severity_threshold %}selected{% endif %}>{{ level }}</option>
                    {% endfor %}
                </select>
             </div>
             <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="notify_email_admin" name="notify_email_admin" value="on" {% if notify_email %}checked{% endif %}>
                <label class="form-check-label" for="notify_email_admin">
                    Notificar por Email (Simulado)
                </label>
            </div>
             <button type="submit" class="btn btn-primary btn-sm">Actualizar Config. Alertas</button>
        </form>
    </div>
</div>

{# --- Sección de Acciones --- #}
<div class="card mb-4">
    <div class="card-header">Acciones de Mantenimiento</div>
    <div class="card-body">
        {# Botón para Reentrenar #}
        <form method="POST" action="{{ url_for('admin_actions') }}" class="d-inline me-2">
             <input type="hidden" name="action" value="retrain">
             <button type="submit" class="btn btn-warning" onclick="return confirm('¿Estás seguro de que deseas reentrenar el modelo? Esto puede tardar y usará los últimos datos preprocesados.');">
                 <i class="fas fa-sync-alt"></i> Reentrenar Modelo
             </button>
             <small class="form-text text-muted d-block">Usa los últimos datos preprocesados para reentrenar y guardar el modelo.</small>
        </form>

        <hr>

        {# Botón para Borrar Alertas #}
        <form method="POST" action="{{ url_for('admin_actions') }}" class="d-inline">
             <input type="hidden" name="action" value="delete_all_alerts">
             <button type="submit" class="btn btn-danger" onclick="return confirm('¡PRECAUCIÓN! ¿Estás seguro de que deseas eliminar TODAS las alertas de la base de datos? Esta acción no se puede deshacer.');">
                 <i class="fas fa-trash-alt"></i> Eliminar Todas las Alertas
             </button>
             <small class="form-text text-muted d-block">Borra permanentemente todo el historial de alertas.</small>
        </form>
    </div>
</div>

{# --- Sección Gestión de Usuarios (Enlaces) --- #}
<div class="card mb-4">
    <div class="card-header">Gestión de Usuarios</div>
    <div class="card-body">
        <a href="{{ url_for('list_users') }}" class="btn btn-secondary"><i class="fas fa-users"></i> Ver/Editar Usuarios</a>
        <a href="{{ url_for('create_user') }}" class="btn btn-success"><i class="fas fa-user-plus"></i> Crear Nuevo Usuario</a>
    </div>
</div>


{# --- Sección de Logs (Placeholder) --- #}
<div class="card">
    <div class="card-header">Logs del Sistema (Ejemplo)</div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto; background-color: #212529; color: #f8f9fa; font-family: monospace; font-size: 0.85em;">
        {# Iterar sobre los logs pasados desde Flask #}
        {% if system_logs %}
            {% for log_line in system_logs %}
                <div>{{ log_line }}</div>
            {% endfor %}
        {% else %}
            <p>No hay logs para mostrar.</p>
        {% endif %}
    </div>
</div>

{% endblock %}