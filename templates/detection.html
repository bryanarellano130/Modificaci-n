{# detection.html #}
{% extends 'base.html' %}

{# Asegúrate de tener un filtro format_datetime definido en tu app.py o en otro lugar accesible #}
{# Por ejemplo, en app.py: @app.template_filter('format_datetime') def format_datetime_filter(value, format='%Y-%m-%d %H:%M:%S'): ... #}

{% block title %}Detección y Análisis{% endblock %}

{% block content %}
<h1>🔍 Detección y Análisis</h1>
{# Este texto ahora es más preciso, ya que el modelo cargado es el entrenado si existe #}
<p>Aplica el modelo de Machine Learning entrenado para detectar amenazas.</p>

<div class="action-card">
    <h2>1. Seleccionar Datos y Ejecutar Detección</h2>
    <p>Selecciona una fuente de datos y haz clic en "Iniciar Detección" para analizarla usando el modelo cargado.</p>
    <form method="POST" action="{{ url_for('detect') }}" id="detection-form">
        <div class="form-group">
            <label for="datasource">Fuente de Datos para Analizar:</label>
            <select id="datasource" name="datasource" required>
                <option value="">-- Selecciona una fuente --</option>
                {% if has_processed_data %}
                    <option value="processed">Usar Datos Cargados y Preprocesados</option>
                {% endif %}
                {% if has_simulation_data %} {# has_simulation_data ahora viene de verificar session['simulation_info'] #}
                    <option value="simulation">Usar Datos de la Última Simulación</option>
                {% endif %}
                {# Podrías añadir opción 'upload_direct' si implementas carga directa aquí #}
            </select>
            {# Mostrar advertencias sobre disponibilidad de datos #}
            {% if not has_processed_data and not has_simulation_data %}
                <p style="color: orange; margin-top: 5px;">No hay fuentes de datos disponibles para analizar. Carga/procesa datos o ejecuta una simulación primero.</p>
            {% else %}
                {% if not has_processed_data %}
                <small style="color: orange; display: block; margin-top: 5px;">Opción 'Datos Preprocesados' no disponible. Carga y preprocesa datos en la sección 'Gestión de Datos'.</small>
                {% endif %}
                {% if not has_simulation_data %}
                <small style="color: orange; display: block; margin-top: 5px;">Opción 'Última Simulación' no disponible. Ejecuta una simulación primero.</small>
                {% endif %}
            {% endif %}
        </div>
        <div class="form-group">
            {# Deshabilitar si no hay fuentes disponibles #}
            <button type="submit" class="button" {% if not has_processed_data and not has_simulation_data %}disabled{% endif %}>Iniciar Detección</button>
        </div>
    </form>

    {# Indicador de carga para submit POST normal #}
    <div id="loading-indicator" style="display: none; margin-top: 1rem;"><p><strong>Ejecutando detección... por favor espera.</strong></p>{# Podrías añadir un spinner CSS aquí #}</div>

</div>

{# --- SECCIÓN: Métricas de Evaluación del Modelo Actual --- #}
{# Este bloque muestra las métricas del modelo CARGADO, evaluado en el test set guardado #}
{% if current_model_metrics %}
    <div class="card mb-3" style="margin-top: 2rem;">
        <div class="card-header">
            Estadísticas de Evaluación del Modelo Actual (en Conjunto de Prueba Guardado)
        </div>
        <div class="card-body">
            {# current_model_metrics ahora puede contener un mensaje de error en 'report' si falló la evaluación #}
            {# Verificamos si accuracy existe y no es None, y si puede ser convertido a float #}
            {% if current_model_metrics.accuracy is not none and (current_model_metrics.accuracy is number or (current_model_metrics.accuracy is string and current_model_metrics.accuracy | float('error') != 'error')) %}
                {# Usamos current_model_metrics.accuracy directamente y aplicamos float filter #}
                <p><strong>Precisión (Accuracy):</strong> {{ current_model_metrics.accuracy | float | default('N/A', true) | round(4) }} ({{ "%.2f%%" % (current_model_metrics.accuracy | float * 100) }})</p>

                {# Mostrar la Matriz de Confusión si está disponible (cm_plot_url viene de app.py) #}
                {% if cm_plot_url %}
                    <h5 style="margin-top: 1.5rem;">Matriz de Confusión:</h5>
                    <img src="{{ cm_plot_url }}" alt="Matriz de Confusión" style="max-width: 400px; height: auto; border: 1px solid #ccc;">
                {% else %}
                     {# Mensaje si cm_plot_url es None #}
                     <p>Gráfica de Matriz de Confusión no disponible.</p>
                {% endif %}

                {# Mostrar el Reporte de Clasificación si el HTML existe (report_df viene de app.py como HTML string) #}
                {% if report_df is not none %} {# report_df ahora es la cadena HTML o un mensaje de error #}
                     {% if report_df is string and report_df.startswith('<p>') %} {# Si es un mensaje de error en <p> #}
                          {{ report_df | safe }} {# Renderizar el mensaje de error #}
                     {% elif report_df is string %} {# Si es la tabla HTML #}
                          <h5 style="margin-top: 1.5rem;">Reporte de Clasificación:</h5>
                          <div class="table-container" style="max-height: 300px; overflow-y: auto;">{# Limitar altura #}
                          {# Renderizamos la cadena HTML generada en app.py. Usamos el filtro | safe para renderizar HTML crudo. #}
                          {{ report_df | safe }}
                          </div>
                     {% else %}
                          {# Caso inesperado #}
                           <p>Reporte de clasificación no disponible o en formato inesperado.</p>
                     {% endif %}
                {% else %}
                    {# Mensaje si report_df es None #}
                    <p>Reporte de clasificación no disponible.</p>
                {% endif %}

                {# Puedes añadir otras métricas aquí si evaluate_on_test_set las proporciona #}

            {% else %}
                {# Mostrar mensaje de error si las métricas no se calcularon o fallaron #}
                 <p>Métricas de evaluación del modelo no disponibles.</p>
                 {# Si current_model_metrics contiene un reporte de error específico #}
                 {% if current_model_metrics.report is not none and current_model_metrics.report is string %}
                      <p style="color: orange;">Detalles: {{ current_model_metrics.report }}</p>
                 {% endif %}
            {% endif %}
        </div>
    </div>
{% else %}
    {# Mensaje si no hay métricas de evaluación disponibles #}
    <div class="alert alert-info" style="margin-top: 2rem;">
        El modelo de detección no ha sido entrenado o no se pudo cargar. Las métricas de evaluación no están disponibles.
        <br>Por favor, carga y preprocesa datos, y luego ve a la sección <a href="{{ url_for('admin_landing') }}">Administración</a> para reentrenar el modelo.
    </div>
{% endif %}


{# --- SECCIÓN: Resultados de la Última Detección Ejecutada --- #}
{# Este bloque muestra el resumen y la vista previa de los datos de la ÚLTIMA vez que se usó el formulario de detección POST #}
{# last_results es el diccionario 'last_detection_results' de la sesión #}
{% if last_results %}
    <div class="card mb-3" style="margin-top: 2rem;">
        <div class="card-header">
            Detalles de la Última Detección Ejecutada ({{ last_results.timestamp | format_datetime if last_results.timestamp else 'Fecha Desconocida' }})
        </div>
        <div class="card-body">
            <p><strong>Fuente de Datos:</strong> {{ last_results.source_info | default('Desconocida', true) }}</p>
            <p><strong>Filas Analizadas:</strong> {{ last_results.rows_analyzed if last_results.rows_analyzed is not none else 'N/A' }}</p>

            {# --- MOSTRAR MÉTRICAS DE ESTA DETECCIÓN ESPECÍFICA (CORREGIDO) --- #}
            {# Si last_results.metrics contiene resultados y tiene 'accuracy' #}
            {% if last_results.metrics and last_results.metrics.accuracy is not none %}
                 <h5 style="margin-top: 1.5rem;">Métricas de Esta Detección:</h5>
                 {# Verificar si metrics.accuracy es un número o una cadena que se puede convertir a número #}
                 {% if last_results.metrics.accuracy is number or (last_results.metrics.accuracy is string and last_results.metrics.accuracy | float('error') != 'error') %}
                      {# Aplicar | float antes de round y la operación matemática #}
                      <p><strong>Precisión (Accuracy):</strong> {{ last_results.metrics.accuracy | float | default(0.0, true) | round(4) }} ({{ "%.2f%%" % (last_results.metrics.accuracy | float * 100) }})</p> {# <-- CORREGIDO #}
                 {% else %}
                      {# Mostrar N/A o el valor tal cual si no es un número o una cadena numérica #}
                      <p><strong>Precisión (Accuracy):</strong> {{ last_results.metrics.accuracy | default('N/A', true) }}</p>
                 {% endif %}


                 {# Puedes añadir aquí la matriz de confusión y reporte de clasificación de esta detección si los guardas en last_results.metrics #}
                 {# Si guardaste la cadena HTML del reporte de esta detección en last_results.metrics.report_html #}
                 {% if last_results.metrics.report_html %}
                      <h6 style="margin-top: 1rem;">Reporte de Clasificación:</h6>
                      <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                           {{ last_results.metrics.report_html | safe }}
                      </div>
                 {% elif last_results.metrics.report %}
                      {# Si solo guardaste el diccionario del reporte, puedes mostrarlo crudo o convertirlo a HTML en app.py #}
                       <h6 style="margin-top: 1rem;">Reporte de Clasificación (Diccionario):</h6>
                       <pre>{{ last_results.metrics.report | tojson(indent=2) }}</pre>
                 {% endif %}
            {% else %}
                 {# Mensaje si no hay métricas guardadas en last_results o no tienen accuracy #}
                 <p>Métricas de esta detección no calculadas o no disponibles (probablemente fuente sin etiquetas 'label').</p>
            {% endif %}


            {# Mostrar resumen de predicciones #}
            {# last_results.detection_summary es el diccionario {'Attack': ..., 'Benign': ..., 'Unknown': ...} #}
            {% if last_results.detection_summary %}
                 <h5 style="margin-top: 1.5rem;">Resumen de Predicciones:</h5>
                 <ul>
                 {% for label, count in last_results.detection_summary.items() %}
                      {# Asegurarse de que count es un número antes de mostrarlo #}
                      <li>{{ label | default('N/A', true) }}: {{ count if count is number else 'N/A' }}</li>
                 {% endfor %}
                 </ul>
            {% else %}
                 {# Mensaje si no hay resumen de predicciones guardado #}
                 <p>Resumen de predicciones no disponible.</p>
            {% endif %}


            {# Añadir el enlace de descarga aquí #}
            {# Este botón solo aparece si last_results existe (indicando que se ejecutó una detección recientemente) #}
            {# La verificación de si los datos están REALMENTE en la sesión para descargar se hace en la ruta /download_detection_results #}
            <div class="mt-3"> {# Añade un pequeño margen superior #}
                {# Enlace al endpoint de descarga #}
                <a href="{{ url_for('download_detection_results') }}" class="btn btn-success">
                    Descargar Resultados CSV
                </a>
            </div>


            {# Mostrar Vista Previa de Datos con Predicciones (data_head_html viene de app.py) #}
            {# data_head_html es la cadena HTML de la tabla generada en app.py #}
            {% if data_head_html is not none %}
                <h5 style="margin-top: 1.5rem;">Vista Previa de Predicciones (Primeras Filas Analizadas)</h5>{# Título más claro #}
                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                    {# Renderizamos la cadena HTML de la tabla. Usamos el filtro | safe. #}
                    {{ data_head_html | safe }}
                </div>
            {% else %}
                    {# Mensaje si data_head_html es None #}
                    <p>No hay vista previa de datos disponible para la última detección.</p>
            {% endif %}
        </div>
    </div>
{% else %}
    {# Mensaje si no hay resultados previos de DETECCION #}
    <p style="margin-top: 1rem;">Selecciona una fuente de datos y ejecuta la detección para ver los detalles de la ejecución aquí.</p>
{% endif %}


{# Historial de Detecciones Guardadas (desde AlertManager) #}
{# detection_history es la lista de diccionarios del historial #}
<div class="card mb-3" style="margin-top: 2rem;">
    <div class="card-header">
        Historial de Detecciones Guardadas
    </div>
    <div class="card-body">
        {% if detection_history %}
            <div class="table-container" style="max-height: 400px; overflow-y: auto;"> {# Contenedor con scroll para el historial #}
                <table class="data-table table-sm"> {# Añadir clase table-sm para que sea más compacta #}
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Fuente Datos</th>{# Añadir columna Fuente Datos #}
                            <th>Filas Analizadas</th>
                            <th>Umbral Modelo</th>
                            <th>Accuracy (en momento de detección)</th> {# Aclarar que es del momento de la detección #}
                            {# Podrías añadir más columnas si guardas más info, ej: resumen de predicciones #}
                        </tr>
                    </thead>
                    <tbody>
                        {# Iteramos sobre el historial. Asumimos que detection_history ya está ordenado (más reciente primero) si se usó get_detection_history() #}
                        {% for entry in detection_history %} {# Iterar directamente si ya está ordenado #}
                            <tr>
                                {# Mostrar Fecha/Hora usando el filtro format_datetime si está definido #}
                                <td>{{ entry.timestamp | format_datetime if entry.timestamp else 'N/A' }}</td>
                                {# Mostrar Fuente Datos, usando default si falta la clave #}
                                <td>{{ entry.source_info | default('Desconocida', true) }}</td>
                                {# Mostrar Filas Analizadas, usando default si falta la clave #}
                                <td>{{ entry.rows_analyzed if entry.rows_analyzed is not none else 'N/A' }}</td>
                                <td>
                                    {# Mostrar Umbral guardado con la entrada del historial #}
                                    {# Verifica si model_threshold existe y no es none #}
                                    {% if entry.model_threshold is not none %}
                                         {# Verifica si es un número antes de formatear #}
                                        {% if entry.model_threshold is number %}
                                            {{ "%.2f" % entry.model_threshold }}
                                        {% else %}
                                            {{ entry.model_threshold }} {# Muestra el valor tal cual si no es número #}
                                        {% endif %}
                                    {% else %}
                                        N/A {# Muestra N/A si falta la clave #}
                                    {% endif %}
                                </td>
                                <td>
                                    {# Mostrar Accuracy guardado con la entrada del historial (CORREGIDO) #}
                                    {# Verificar si metrics existe y si metrics.accuracy existe y no es None #}
                                    {% if entry.metrics and entry.metrics.accuracy is not none %}
                                         {# Aplicar | float antes de formatear #}
                                        {% if entry.metrics.accuracy is number or (entry.metrics.accuracy is string and entry.metrics.accuracy | float('error') != 'error') %}
                                            {{ "%.4f" % (entry.metrics.accuracy | float) }} {# <-- CORREGIDO #}
                                        {% else %}
                                            {{ entry.metrics.accuracy | default('N/A', true) }} {# Muestra el valor tal cual si no es número/cadena numérica, o N/A #}
                                        {% endif %}
                                    {% else %}
                                         N/A {# Esto será N/A si metrics o accuracy falta #}
                                    {% endif %}
                                </td>
                                {# ... posibles otras celdas ... #}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div> {# Cierre del table-container #}
        {% else %}
            <p>No hay historial de detecciones guardadas.</p>
        {% endif %}
    </div>
</div>


{% endblock %}

{# Puedes añadir estilos específicos aquí o en style.css #}
{% block extra_css %}
<style>
    /* Estilos para tablas */
    .data-table { width: 100%; border-collapse: collapse; } /* Eliminado margin-top: 1.5rem para usar con table-container */
    .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .data-table th { background-color: #f2f2f2; }
    .data-table tr:nth-child(even) { background-color: #f9f9f9; }
    .data-table tr:hover { background-color: #e9e9e9; }
    .table-container { max-height: 400px; overflow-y: auto; margin-top: 1rem; border: 1px solid #ccc; border-radius: 5px;} /* Añadido borde-radius */
    .table-container table { margin-top: 0; } /* Elimina margen superior de la tabla dentro del contenedor */
    .data-table.table-sm th, .data-table.table-sm td { padding: 0.5rem; font-size: 0.9rem; }

    /* Estilos para tarjetas */
    .card {
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 2px 2px 12px rgba(0,0,0,0.1);
    }
    .card-header {
        background-color: #f7f7f7;
        padding: 10px 15px;
        border-bottom: 1px solid #ccc;
        font-weight: bold;
    }
    .card-body {
        padding: 15px;
    }

    /* Estilo para el botón de descarga */
    .btn {
        display: inline-block;
        font-weight: 400;
        color: #212529;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        text-decoration: none; /* Quitar subrayado */
    }
    .btn-success {
        color: #fff;
        background-color: #28a745;
        border-color: #28a745;
    }
    .btn-success:hover {
        color: #fff;
        background-color: #218838;
        border-color: #1e7e34;
    }
    /* Estilo para mensajes de alerta */
    .alert {
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }
    .alert-info {
        color: #0c5460;
        background-color: #d1ecf1;
        border-color: #bee5eb;
    }
</style>
{% endblock %}

{% block extra_js %}
{# Script para mostrar/ocultar indicador de carga para submit POST normal #}
<script>
    console.log("Detection JS loaded");
    const detectionForm = document.getElementById('detection-form');
    const loadingIndicator = document.getElementById('loading-indicator');

    if (detectionForm && loadingIndicator) {
        detectionForm.addEventListener('submit', function() {
            loadingIndicator.style.display = 'block';
            // Deshabilitar el botón para evitar múltiples envíos
            detectionForm.querySelector('button[type="submit"]').disabled = true;
        });
    }

    // Función para formatear fecha y hora (asume que format_datetime filtro no está disponible)
    // Es mejor usar el filtro format_datetime en app.py si ya lo tienes definido.
    // Si no, puedes implementar una función JS aquí para formatear timestamps ISO 8601.
</script>
{% endblock %}